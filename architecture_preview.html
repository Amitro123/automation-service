<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Automation Agent - Architecture Preview</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        h2 {
            color: #34495e;
            margin-top: 30px;
        }

        .mermaid {
            background: white;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .info-box {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .success-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .feature-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .feature-card h3 {
            margin-top: 0;
            color: #495057;
            font-size: 16px;
        }

        .feature-card ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .feature-card li {
            margin: 5px 0;
            font-size: 14px;
        }

        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üèóÔ∏è GitHub Automation Agent - System Architecture</h1>

        <div class="success-box">
            <strong>‚úÖ Architecture Updated!</strong><br>
            This diagram now includes all recent enhancements: Dashboard Real Data Integration, Mutation Testing
            (Linux/Mac/CI), and Security improvements.
        </div>

        <h2>üìä System Diagram</h2>
        <div class="mermaid">
            graph TD
            %% Styles
            classDef component fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
            classDef memory fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;
            classDef external fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px;
            classDef orchestrator fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;
            classDef frontend fill:#ffe0b2,stroke:#f57c00,stroke-width:2px;
            classDef primary fill:#d1c4e9,stroke:#512da8,stroke-width:3px;
            classDef fallback fill:#f5f5f5,stroke:#9e9e9e,stroke-width:2px,stroke-dasharray: 5,5;
            classDef ci fill:#e0f7fa,stroke:#006064,stroke-width:2px;
            classDef api fill:#ffecb3,stroke:#ff6f00,stroke-width:2px;

            %% External Systems
            subgraph External["External Systems"]
            GitHub[GitHub Push Event]:::external
            GitHubAPI[GitHub API]:::external
            end

            %% CI/Automation Layer
            subgraph CI["CI/Automation (Linux Runner)"]
            Pytest[pytest]:::ci
            Mutmut[mutmut]:::ci
            end

            %% Backend Core (The Brain)
            subgraph Backend["Backend Core (The Brain)"]
            Webhook[Webhook Server]:::component
            Orchestrator[Async Orchestrator]:::orchestrator
            SessionMem[Session Memory Store]:::memory
            MutationService[Mutation Service]:::component

            %% Review Providers Abstraction
            subgraph ReviewAbstraction["Review Providers"]
            ReviewProv[ReviewProvider Interface]:::component
            end

            %% Parallel Tasks
            subgraph Tasks["Parallel Tasks"]
            Reviewer[Code Reviewer]:::component
            ReadmeUp[README Updater]:::component
            SpecUp[Spec Updater]:::component
            ReviewUp[Code Review Updater]:::component
            end
            end

            %% API Gateway Layer
            subgraph APILayer["API Gateway Layer"]
            APIServer[FastAPI API Server]:::api
            end

            %% Artifacts
            subgraph Artifacts["Repo Artifacts"]
            SpecMD[spec.md]:::memory
            ReadmeMD[README.md]:::memory
            ReviewMD[code_review.md]:::memory
            MutationRes[mutation_results.json]:::memory
            CoverageXML[coverage.xml]:::memory
            end

            %% Frontend (Consumer)
            subgraph Frontend["Frontend (Consumer)"]
            Dashboard[React Dashboard]:::frontend
            end

            %% Review Providers Implementation
            subgraph Providers["Review Engines"]
            Jules["Jules API (Primary)"]:::primary
            LLM["LLMs (Gemini/OpenAI/Anthropic) Fallback"]:::fallback
            end

            %% Data Flow - Ingress
            GitHub -->|POST /webhook| Webhook
            Webhook -->|Trigger| Orchestrator

            %% Orchestration
            Orchestrator -->|Init Run| SessionMem
            Orchestrator -->|Parallel Exec| Reviewer
            Orchestrator -->|Parallel Exec| ReadmeUp
            Orchestrator -->|Parallel Exec| SpecUp
            Orchestrator -->|Parallel Exec| ReviewUp
            Orchestrator -->|Update Status| SessionMem

            %% Mutation & CI Flow
            Webhook -->|Run /api/mutation/run| MutationService
            MutationService -->|Exec| Mutmut
            Mutmut -->|Write| MutationRes
            Pytest -->|Write| CoverageXML

            %% Metrics Flow
            MutationRes -->|Read| APIServer
            CoverageXML -->|Read| APIServer
            SessionMem -->|Read Metrics| APIServer

            %% API Layer
            APIServer -->|/api/metrics| Dashboard
            APIServer -->|/api/architecture| Dashboard
            APIServer -->|/api/history| Dashboard
            APIServer -->|/api/mutation/results| Dashboard

            %% Component Interactions
            Reviewer -->|Delegate| ReviewProv
            ReadmeUp -->|Delegate| ReviewProv
            SpecUp -->|Delegate| ReviewProv

            %% Review Provider Logic
            ReviewProv -->|Primary Selection| Jules
            ReviewProv -.->|Fallback if Failed| LLM

            %% External Interactions
            Reviewer -->|Post Comment| GitHubAPI
            Reviewer -->|Log Result| SessionMem

            ReadmeUp -->|Read Content| ReadmeMD
            ReadmeUp -->|Create PR| GitHubAPI
            ReadmeUp -->|Log Result| SessionMem

            SpecUp -->|Read History| SpecMD
            SpecUp -->|Append Entry| GitHubAPI
            SpecUp -->|Log Result| SessionMem

            ReviewUp -->|Read Log| ReviewMD
            ReviewUp -->|Summarize| LLM
            ReviewUp -->|Append Log| GitHubAPI

            %% Memory Updates
            SpecUp -.->|Update| SpecMD
            ReadmeUp -.->|Update| ReadmeMD
            ReviewUp -.->|Update| ReviewMD

            %% Notes
            note1[Mutation testing supported only on<br />Linux/Mac/CI. Skipped on Windows.]
            Mutmut --- note1

            note2[Review engine configurable via<br />environment variables.]
            ReviewProv --- note2
        </div>

        <h2>üéØ Recent Enhancements</h2>

        <div class="feature-list">
            <div class="feature-card">
                <h3>üìä Dashboard Real Data Integration</h3>
                <ul>
                    <li>Real coverage from <code>coverage.xml</code></li>
                    <li>Live bugs from GitHub issues</li>
                    <li>Real PRs with check status</li>
                    <li>LLM metrics from SessionMemory</li>
                    <li>Live architecture diagram</li>
                </ul>
            </div>

            <div class="feature-card">
                <h3>üß¨ Mutation Testing</h3>
                <ul>
                    <li>‚úÖ Linux/Mac: Full support</li>
                    <li>‚úÖ CI/CD: GitHub Actions</li>
                    <li>‚ö†Ô∏è Windows: Graceful skip</li>
                    <li>API: <code>/api/mutation/run</code></li>
                    <li>Results cached in JSON</li>
                </ul>
            </div>

            <div class="feature-card">
                <h3>üîí Security Enhancements</h3>
                <ul>
                    <li>defusedxml for XML parsing</li>
                    <li>Prevents XXE attacks</li>
                    <li>0 Medium/High Bandit issues</li>
                    <li>All best practices followed</li>
                </ul>
            </div>

            <div class="feature-card">
                <h3>üöÄ CI/CD Integration</h3>
                <ul>
                    <li>GitHub Actions workflow</li>
                    <li>Automated mutation tests</li>
                    <li>PR comments with scores</li>
                    <li>Artifact storage (30 days)</li>
                </ul>
            </div>
        </div>

        <h2>üõ†Ô∏è Technology Stack</h2>
        <div class="info-box">
            <strong>Backend:</strong> FastAPI, Flask, httpx, defusedxml<br>
            <strong>Frontend:</strong> React + TypeScript, Vite, Mermaid<br>
            <strong>Testing:</strong> pytest, pytest-cov, mutmut (Linux/Mac/CI), bandit<br>
            <strong>LLM:</strong> Gemini (primary), OpenAI, Anthropic, Jules API<br>
            <strong>Infrastructure:</strong> GitHub Actions, Session Memory, GitHub API
        </div>

        <div class="success-box">
            <strong>üéâ Status: Production Ready!</strong><br>
            All features implemented, tested, and documented. Ready for deployment.
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>

</html>