============================= test session starts =============================
platform win32 -- Python 3.11.9, pytest-9.0.0, pluggy-1.6.0 -- C:\Users\USER\AppData\Local\Microsoft\WindowsApps\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\USER\AutomationService\automation-service
configfile: pytest.ini
plugins: anyio-4.11.0, logfire-4.14.2, asyncio-1.3.0, cov-7.0.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 4 items

tests/test_webhook_server.py::TestWebhookServer::test_health_check PASSED [ 25%]
tests/test_webhook_server.py::TestWebhookServer::test_webhook_invalid_signature PASSED [ 50%]
tests/test_webhook_server.py::TestWebhookServer::test_webhook_push_event FAILED [ 75%]
tests/test_webhook_server.py::TestWebhookServer::test_webhook_valid_signature_ping PASSED [100%]

================================== FAILURES ===================================
__________________ TestWebhookServer.test_webhook_push_event __________________

self = <tests.test_webhook_server.TestWebhookServer testMethod=test_webhook_push_event>

    def test_webhook_push_event(self):
        payload = {
            "ref": "refs/heads/main",
            "commits": [{"id": "sha1", "message": "test"}],
            "head_commit": {"id": "sha1", "message": "test"}
        }
        data = json.dumps(payload).encode()
    
        mac = hmac.new(b'secret', msg=data, digestmod=hashlib.sha256)
        signature = f"sha256={mac.hexdigest()}"
    
        headers = {
            'X-Hub-Signature-256': signature,
            'X-GitHub-Event': 'push',
            'Content-Type': 'application/json'
        }
    
        # Mock orchestrator
        self.server.orchestrator.process_push.return_value = {"success": True}
    
        response = self.app.post('/webhook', headers=headers, data=data)
>       self.assertEqual(response.status_code, 200)
E       AssertionError: 500 != 200

tests\test_webhook_server.py:79: AssertionError
------------------------------ Captured log call ------------------------------
ERROR    src.automation_agent.webhook_server:webhook_server.py:160 Error processing push event: object MagicMock can't be used in 'await' expression
Traceback (most recent call last):
  File "C:\Users\USER\AutomationService\automation-service\src\automation_agent\webhook_server.py", line 146, in _handle_push_event
    result = await self.orchestrator.run_automation(payload)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: object MagicMock can't be used in 'await' expression
=========================== short test summary info ===========================
FAILED tests/test_webhook_server.py::TestWebhookServer::test_webhook_push_event
========================= 1 failed, 3 passed in 0.72s =========================
