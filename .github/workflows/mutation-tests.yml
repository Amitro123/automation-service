name: Mutation Testing

on:
  # Trigger on pushes to main branch
  push:
    branches:
      - main
  # Allow manual trigger
  workflow_dispatch:
  # Optionally trigger on PRs to main
  # pull_request:
  #   branches:
  #     - main

jobs:
  mutation-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run pytest with coverage
        run: |
          pytest --cov=src/automation_agent --cov-report=xml --cov-report=term
        continue-on-error: true
      
      - name: Run mutation tests
        env:
          PYTHONPATH: ${{ github.workspace }}/src
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'src')
          from automation_agent.mutation_service import run_mutation_tests
          
          print('Starting mutation tests...')
          results = run_mutation_tests(max_runtime_seconds=600)
          
          print(f'Mutation tests completed!')
          print(f'Mutation Score: {results.get(\"mutation_score\", 0)}%')
          print(f'Total Mutants: {results.get(\"mutants_total\", 0)}')
          print(f'Killed: {results.get(\"mutants_killed\", 0)}')
          print(f'Survived: {results.get(\"mutants_survived\", 0)}')
          
          # Results are already saved to mutation_results.json by the service
          "
      
      - name: Upload mutation results
        uses: actions/upload-artifact@v4
        with:
          name: mutation-results
          path: mutation_results.json
          retention-days: 30
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 30
      
      - name: Display mutation summary
        if: always()
        run: |
          if [ -f mutation_results.json ]; then
            echo "## Mutation Testing Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            python -c "
          import json
          with open('mutation_results.json', 'r') as f:
              data = json.load(f)
          
          print(f'**Mutation Score:** {data.get(\"mutation_score\", 0)}%')
          print(f'**Total Mutants:** {data.get(\"mutants_total\", 0)}')
          print(f'**Killed:** {data.get(\"mutants_killed\", 0)}')
          print(f'**Survived:** {data.get(\"mutants_survived\", 0)}')
          print(f'**Timeout:** {data.get(\"mutants_timeout\", 0)}')
          print(f'**Suspicious:** {data.get(\"mutants_suspicious\", 0)}')
          print(f'**Runtime:** {data.get(\"runtime_seconds\", 0):.1f}s')
          " >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è No mutation results found" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            if (!fs.existsSync('mutation_results.json')) {
              console.log('No mutation results to comment');
              return;
            }
            
            const results = JSON.parse(fs.readFileSync('mutation_results.json', 'utf8'));
            
            const comment = `## üß¨ Mutation Testing Results
            
            | Metric | Value |
            |--------|-------|
            | **Mutation Score** | ${results.mutation_score}% |
            | **Total Mutants** | ${results.mutants_total} |
            | **Killed** | ${results.mutants_killed} ‚úÖ |
            | **Survived** | ${results.mutants_survived} ‚ö†Ô∏è |
            | **Timeout** | ${results.mutants_timeout} ‚è∞ |
            | **Suspicious** | ${results.mutants_suspicious} ü§î |
            | **Runtime** | ${results.runtime_seconds.toFixed(1)}s |
            
            ${results.mutation_score >= 80 ? '‚úÖ Great mutation coverage!' : results.mutation_score >= 60 ? '‚ö†Ô∏è Consider improving mutation coverage' : '‚ùå Low mutation coverage - tests may not be effective'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
