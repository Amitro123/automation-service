# üéØ Jules API Integration - Complete Implementation

## ‚úÖ **What Was Implemented:**

### **1. Proper Jules API Workflow**

Based on official documentation (https://developers.google.com/jules/api), Jules API works with **sessions**, not direct review endpoints:

1. **Create Session** - POST to `/v1alpha/sessions` with code diff
2. **Poll Session** - GET `/v1alpha/sessions/{id}` until complete
3. **Extract Review** - Parse outputs from completed session

### **2. Updated `JulesReviewProvider`** (`src/automation_agent/review_provider.py`)

**Key Changes:**
- ‚úÖ Correct base URL: `https://jules.googleapis.com/v1alpha`
- ‚úÖ Correct authentication: `X-Goog-Api-Key` header (not Bearer)
- ‚úÖ Session-based workflow with polling
- ‚úÖ Comprehensive `[JULES]` logging at every step
- ‚úÖ Structured error returns with proper error types
- ‚úÖ Fallback to LLM only on transient errors (5xx)
- ‚úÖ No fallback on 404 (configuration error)

**Error Types:**
- `jules_404` - Source ID not found (misconfiguration)
- `jules_auth_error` - API key invalid (401/403)
- `jules_client_error` - Other 4xx errors
- `jules_empty_response` - Session completed but no review
- Server errors (5xx) ‚Üí Falls back to LLM

### **3. Configuration** (`src/automation_agent/config.py`)

**New Environment Variables:**
```python
JULES_API_URL = "https://jules.googleapis.com/v1alpha"  # Base URL
JULES_SOURCE_ID = "sources/github/owner/repo"  # Required
JULES_PROJECT_ID = ""  # Optional
```

**Validation:**
- Requires `JULES_API_KEY` when `REVIEW_PROVIDER=jules`
- Requires `JULES_SOURCE_ID` when `REVIEW_PROVIDER=jules`

### **4. Environment Configuration** (`.env.example`)

Added comprehensive Jules configuration with comments:
```bash
# Review Provider Configuration
REVIEW_PROVIDER=llm  # or "jules"

# Jules API Configuration
JULES_API_KEY=your_jules_api_key_here
JULES_API_URL=https://jules.googleapis.com/v1alpha
JULES_SOURCE_ID=sources/github/your_username/your_repo
JULES_PROJECT_ID=  # Optional
```

### **5. Diagnostic Script** (`test_jules_review.py`)

Test Jules API integration locally:
```bash
python test_jules_review.py
```

**Features:**
- ‚úÖ Validates configuration
- ‚úÖ Tests Jules API with sample diff
- ‚úÖ Shows detailed error messages
- ‚úÖ Provides troubleshooting steps
- ‚úÖ Displays review output on success

## üìä **How It Works:**

### **Request Flow:**

```
1. CodeReviewer.review_commit()
   ‚Üì
2. JulesReviewProvider.review_code(diff)
   ‚Üì
3. POST /v1alpha/sessions
   Headers: X-Goog-Api-Key: YOUR_KEY
   Body: {
     "prompt": "Please review this code change:\n\n```diff\n...\n```",
     "sourceContext": {"source": "sources/github/owner/repo"},
     "title": "Code Review Request",
     "requirePlanApproval": false
   }
   ‚Üì
4. Response: {"id": "session_id", "name": "sessions/123", ...}
   ‚Üì
5. Poll GET /v1alpha/sessions/{id} (every 3 seconds, max 10 times)
   ‚Üì
6. Extract review from session.outputs[]
   ‚Üì
7. Return formatted review or error dict
```

### **Error Handling:**

```python
# 404 - Configuration Error (NO FALLBACK)
{
    "success": False,
    "error_type": "jules_404",
    "message": "Jules API returned 404. Check JULES_SOURCE_ID configuration.",
    "status_code": 404
}

# 401/403 - Auth Error (NO FALLBACK)
{
    "success": False,
    "error_type": "jules_auth_error",
    "message": "Jules API authentication failed. Check JULES_API_KEY.",
    "status_code": 401
}

# 5xx - Server Error (FALLBACK TO LLM)
Falls back to Gemini/OpenAI/Anthropic automatically

# Success
"# ü§ñ Jules Code Review\n\n[review content]\n\n---\n*Generated by Jules*"
```

### **Orchestrator Integration:**

```python
# In orchestrator.py
if not review_success:
    error_type = review_result.get("error_type")
    error_message = review_result.get("message")
    
    # Mark task as failed in SessionMemory
    self.session_memory.mark_task_failed(
        run_id, "code_review", error_message, error_type
    )
    
    # Run status becomes "failed" or "completed_with_issues"
```

## üîß **Setup Instructions:**

### **Step 1: Get Jules API Key**

1. Visit https://developers.google.com/jules/api
2. Follow authentication instructions
3. Generate API key

### **Step 2: Find Your Source ID**

```bash
curl 'https://jules.googleapis.com/v1alpha/sources' \
  -H 'X-Goog-Api-Key: YOUR_API_KEY'
```

Response:
```json
{
  "sources": [
    {
      "name": "sources/github/Amitro123/automation-service",
      "id": "github/Amitro123/automation-service",
      "githubRepo": {
        "owner": "Amitro123",
        "repo": "automation-service"
      }
    }
  ]
}
```

Copy the `name` field (e.g., `sources/github/Amitro123/automation-service`)

### **Step 3: Update `.env`**

```bash
REVIEW_PROVIDER=jules
JULES_API_KEY=your_actual_api_key_here
JULES_SOURCE_ID=sources/github/Amitro123/automation-service
```

### **Step 4: Test Integration**

```bash
python test_jules_review.py
```

Expected output:
```
‚úÖ Configuration valid!
üöÄ Testing Jules API with sample diff...
[JULES] Creating session at https://jules.googleapis.com/v1alpha/sessions
[JULES] ‚úÖ Session created: 123456
[JULES] Polling session status: 123456
[JULES] ‚úÖ Review received (1234 chars)
üéâ SUCCESS! Jules API is working correctly!
```

### **Step 5: Restart Server**

```bash
# Kill existing server
Get-Process | Where-Object {$_.ProcessName -eq "python"} | Stop-Process -Force

# Start with new configuration
python run_api.py
```

## üìà **Expected Behavior:**

### **On Success:**
```
[CODE_REVIEW] [run_id=...] [pr=67] Starting code review for commit abc123
[JULES] Requesting code review from Jules API...
[JULES] Source: sources/github/Amitro123/automation-service
[JULES] Creating session at https://jules.googleapis.com/v1alpha/sessions
[JULES] Response status: 200
[JULES] ‚úÖ Session created: 123456
[JULES] Polling session status: 123456
[JULES] Poll 1/10: state=ACTIVE
[JULES] Poll 2/10: state=COMPLETED
[JULES] ‚úÖ Review received (2345 chars)
[CODE_REVIEW] ‚úÖ Successfully posted review on PR #67
[ORCHESTRATOR] ‚úÖ Code review completed successfully
```

### **On 404 Error:**
```
[JULES] Response status: 404
[JULES] ‚ùå Jules API returned 404. Check JULES_SOURCE_ID configuration.
[ORCHESTRATOR] Code review failed: error_type=jules_404, message=...
```

**SessionMemory:**
```json
{
  "failed_tasks": ["code_review"],
  "failure_reasons": {
    "code_review": {
      "error_type": "jules_404",
      "reason": "Jules API returned 404. Check JULES_SOURCE_ID configuration."
    }
  }
}
```

### **On 5xx Error (Fallback):**
```
[JULES] Jules API server error (503), falling back to LLM provider.
[LLM] Generating review with Gemini...
[CODE_REVIEW] ‚úÖ Review generated successfully (using LLM fallback)
```

## ‚úÖ **Acceptance Criteria Met:**

1. ‚úÖ **Correct Jules API Integration**
   - Uses official API endpoints
   - Proper session workflow
   - Correct authentication headers

2. ‚úÖ **Configuration**
   - `JULES_SOURCE_ID` and `JULES_PROJECT_ID` in config
   - Validation ensures required fields
   - Clear documentation in `.env.example`

3. ‚úÖ **Error Handling**
   - `jules_404` for misconfiguration (no fallback)
   - `jules_auth_error` for auth failures
   - Fallback to LLM only on 5xx
   - All errors logged and tracked

4. ‚úÖ **Logging**
   - `[JULES]` prefix on all logs
   - Request/response details (without secrets)
   - Clear success/failure indicators

5. ‚úÖ **SessionMemory Integration**
   - `mark_task_failed()` called on errors
   - Error type and message persisted
   - Run status reflects failures

6. ‚úÖ **Diagnostic Tools**
   - `test_jules_review.py` for local testing
   - Clear troubleshooting steps
   - Validation before API calls

## üöÄ **Next Steps:**

1. **Configure Jules** - Add API key and source ID to `.env`
2. **Test Locally** - Run `python test_jules_review.py`
3. **Restart Server** - Load new configuration
4. **Make Test Commit** - Trigger automation
5. **Verify** - Check logs for `[JULES]` messages

## üìö **Resources:**

- **Jules API Docs**: https://developers.google.com/jules/api
- **API Reference**: https://developers.google.com/jules/api/reference/rest
- **Authentication**: https://developers.google.com/jules/api#authentication
- **Quickstart**: https://developers.google.com/jules/api#quickstart

---

**Status**: ‚úÖ Complete and ready for testing
**Files Modified**: 
- `src/automation_agent/review_provider.py`
- `src/automation_agent/config.py`
- `.env.example`
**Files Created**:
- `test_jules_review.py`
- `JULES_API_INTEGRATION.md`
